<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <record id="som_crm_lead_view_form" model="ir.ui.view">
        <field name="model">crm.lead</field>
        <field name="inherit_id" ref="crm.crm_lead_view_form" />
        <field name="arch" type="xml">

            <xpath expr="//group[@name='opportunity_partner']" position="inside">
                <field name="som_cups"/>
                <field name="som_erp_lead_id" readonly="1"/>
                <field name="som_last_call_date"/>
                <field name="som_last_act_done_mail_date"/>
                <field name="som_id_meta" readonly="1"/>
            </xpath>

            <xpath expr="//group[@name='lead_partner']//field[@name='lang_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//page[@name='lead']//field[@name='lang_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//field[@name='tag_ids']" position="after">
                <field name="som_self_consumption"/>
                <field name="som_pricelist"/>
                <field name="som_preferred_contact_time_ids"
                       widget="many2many_tags"
                       options="{'color_field': 'color'}"/>
                <field name="lang_id"
                    options="{'no_quick_create': True, 'no_create_edit': True, 'no_open': True}"/>
                <field name="som_comparison_result"/>
                <field name="som_next_renovation_date"/>
            </xpath>


            <xpath expr="//group[@name='lead_partner']" position="inside">
                <field name="som_cups"/>
                <field name="som_erp_lead_id" readonly="1"/>
                <field name="som_last_call_date"/>
                <field name="som_last_act_done_mail_date"/>
                <field name="som_id_meta" readonly="1"/>
            </xpath>

            <xpath expr="//group[@name='lead_info']" position="inside">
                <field name="som_self_consumption"/>
                <field name="som_pricelist"/>
                <field name="som_preferred_contact_time_ids"
                       widget="many2many_tags"
                       options="{'color_field': 'color'}"/>
                <field name="lang_id"
                    options="{'no_quick_create': True, 'no_create_edit': True, 'no_open': True}"/>
                <field name="som_comparison_result"/>
                <field name="som_next_renovation_date"/>
            </xpath>

            <xpath expr="//label[@for='contact_name_page_lead']"  position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@id='contact_name_page_lead']/.."  position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//group/group[@name='opportunity_partner']/field[@name='partner_id']" position="after">
                <label for="som_contact_name_page_lead"/>
                <div class="o_row">
                    <field name="contact_name" id="som_contact_name_page_lead"/>
                </div>
            </xpath>

            <xpath expr="//button[@name='action_set_won_rainbowman']" position="before">
                <button
                    string="Assign to me"
                    name="assign_to_me"
                    type="object"
                    attrs="{'invisible' : [('user_id', '!=', False)]}"
                />
                <button
                    string="Assign partner"
                    name="assign_partner"
                    type="object"
                    attrs="{'invisible' : [('partner_id', '!=', False)]}"
                />
            </xpath>

             <xpath expr="//page[@name='extra']//field[@name='source_id']" position="after">
                <field name="som_channel" required="1"/>
                <field name="som_url_origin" required="0"/>
            </xpath>
            <xpath expr="//page[@name='lead']//field[@name='source_id']" position="after">
                <field name="som_channel" required="1"/>
                <field name="som_url_origin" widget="url" required="0"/>
            </xpath>

            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" icon="fa-envelope" name="button_open_activities_by_type" type="object"
                        context="{'activity_type':'mail.mail_activity_data_email'}" attrs="{'invisible': [('type', '=', 'lead')]}">
                    <field name="som_mail_activity_count" string="Email" widget="statinfo"/>
                </button>
                <button class="oe_stat_button" icon="fa-tasks" name="button_open_activities_by_type" type="object"
                        context="{'activity_type':'mail.mail_activity_data_todo'}" attrs="{'invisible': [('type', '=', 'lead')]}">
                    <field name="som_task_activity_count" string="Task" widget="statinfo"/>
                </button>
                <button class="oe_stat_button" icon="fa-gears" name="button_open_activities_by_type" type="object"
                        context="{'activity_type':'som_crm.som_upcoming_activity'}" attrs="{'invisible': [('type', '=', 'lead')]}">
                    <field name="som_upcomming_activity_count" string="Upcoming" widget="statinfo"/>
                </button>
                <button class="oe_stat_button" icon="fa-users" name="button_open_activities_by_type" type="object"
                        context="{'activity_type':'mail.mail_activity_data_meeting'}" attrs="{'invisible': [('type', '=', 'lead')]}">
                    <field name="som_meeting_activity_count" string="Meeting" widget="statinfo"/>
                </button>
            </xpath>

        </field>
    </record>

    <record id="quick_create_opportunity_form" model="ir.ui.view">
        <field name="inherit_id" ref="crm.quick_create_opportunity_form" />
        <field name="model">crm.lead</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <field name="som_channel" required="1"/>
            </xpath>
        </field>
    </record>

    <record id="som_crm_lead_view_kanban" model="ir.ui.view">
        <field name="model">crm.lead</field>
        <field name="inherit_id" ref="crm.crm_case_kanban_view_leads"/>
        <field name="arch" type="xml">
            <field name="recurring_revenue_monthly" position="after">
                <field name="som_last_call_date"/>
            </field>
            <xpath expr="//field[@name='tag_ids']/.." position="after">
                <div>
                    <field name="som_last_call_date"/>
                </div>
            </xpath>
            <xpath expr="//progressbar[@field='activity_state']" position="attributes">
                <attribute name="sum_field"></attribute>
            </xpath>
        </field>
    </record>

    <record model="ir.ui.view" id="som_view_crm_case_opportunities_filter">
        <field name="model">crm.lead</field>
        <field name="inherit_id" ref="crm.view_crm_case_opportunities_filter" />
        <field name="arch" type="xml">
            <filter name="open_opportunities" position="after">
                <separator/>
                <filter string="Contacted today" name="som_ct" domain="[('som_last_call_date_only', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Not contacted today phone" name="som_nct" domain="['|',('som_last_call_date','=', False), ('som_last_call_date_only', '!=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Not contacted yesterday" name="som_nct_last_1_days" domain="['|',('som_last_call_date','=', False), ('som_last_call_date_only', '&lt;', datetime.datetime.now() - relativedelta(days=1))]"/>
                <filter string="Not contacted last 2 Days" name="som_nct_last_2_days" domain="['|',('som_last_call_date','=', False), ('som_last_call_date_only', '&lt;', datetime.datetime.now() - relativedelta(days=2))]"/>
                <filter string="Not contacted last 3 Days" name="som_nct_last_3_days" domain="['|',('som_last_call_date','=', False), ('som_last_call_date_only', '&lt;', datetime.datetime.now() - relativedelta(days=3))]"/>
                <filter string="Not contacted last 4 Days" name="som_nct_last_4_days" domain="['|',('som_last_call_date','=', False), ('som_last_call_date_only', '&lt;', datetime.datetime.now() - relativedelta(days=4))]"/>
                <separator/>
                <filter string="Without phone" name="som_no_phone" domain="[('phone', '=', False)]"/>
                <separator/>
                <filter string="Not contacted today mail" name="som_nctm" domain="['|',('som_last_act_done_mail_date','=', False), ('som_last_act_done_mail_date_only', '!=', context_today().strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter string="Activity due today or before" name="som_activity_due_today_or_before" domain="[('activity_date_deadline', '&lt;=', context_today().strftime('%Y-%m-%d'))]"/>
                <separator/>
            </filter>
        </field>
    </record>

    <record id="som_crm_lead_view_tree_opportunity" model="ir.ui.view">
        <field name="model">crm.lead</field>
        <field name="inherit_id" ref="crm.crm_case_tree_view_oppor" />
        <field name="arch" type="xml">
            <field name="create_date" position="after">
                <field name="date_closed" optional="hide"/>
                <field name="day_close" optional="hide"/>
            </field>

            <field name="source_id" position="after">
                <field name="som_comparison_result" optional="show"/>
                <field name="som_next_renovation_date" optional="show"/>
                <field name="som_url_origin" widget="url" optional="hide"/>
                <field name="som_id_meta" readonly="1" optional="hide"/>
            </field>
        </field>
    </record>

</odoo>
